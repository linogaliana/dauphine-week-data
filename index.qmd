---
title: Mise en production de mod√®les de _machine learning_
subtitle: |
  **[Une introduction]{.orange}**
author: |
    [Lino Galiana](https://www.linogaliana.fr/)
institute: |
    [Lino Galiana](https://www.linogaliana.fr/)
#date: 06-09-2023
slide-number: true
footer: |
  **_PSL Data Week_**
# uncomment for French presentations:
lang: fr-FR
# for blind readers:
slide-tone: false
# for @olevitt:
#chalkboard: # press the B key to toggle chalkboard
#  theme: whiteboard
# uncomment to use the multiplex mode:
#multiplex: true
format:
  # pick the light mode (onyxia-revealjs) or the dark mode (onyxia-dark-revealjs)
  onyxia-revealjs
  #onyxia-dark-revealjs:
    #output-file: slides.html
from: markdown+emoji
css: custom.css
---


## Plan

1. Evolutions r√©centes de l'√©cosyst√®me de la donn√©e ;
2. Pourquoi parler de mise en production ? ;

## Objectifs p√©dagogiques

- Comprendre les implications pratiques de l'utilisation accrue du _machine learning_ ;

. . .

- Mettre en oeuvre un _pipeline_ de _machine learning_ avec `Python` ;
    + Donn√©es de transactions immobili√®res DVF

. . .

- D√©couvrir la mise √† disposition de mod√®les sous forme d'API


{{< include "_0_contexte.qmd"  >}}


{{< include "_1_introduction.qmd"  >}}

# Application 1: _pipeline_ de _machine learning_

## Prise en main du `SSP Cloud`

![](https://git.lab.sspcloud.fr/diit/presentation/energy-data-hack-2022/20220523-day_1-onyxia_onboarding/-/raw/main/slideshow/DragonHoldingComputer.svg)

## Le SSP Cloud, c'est quoi ?

![](https://git.lab.sspcloud.fr/diit/presentation/energy-data-hack-2022/20220523-day_1-onyxia_onboarding/-/raw/main/slideshow/macbook_onyxia.png)

## Le SSP Cloud, c'est quoi ?

- Des serveurs h√©berg√©s √† l'Insee avec de nombreux logiciels statistiques (dont {{< fa brands python >}} ) dessus
- Environnement ouvert √† des formations en _data science_
pour d√©couvrir et exp√©rimenter
- __Seulement avec des donn√©es en open data__


:::{.callout-note}
Plus de d√©tails dans la [documentation du `SSP Cloud`](https://www.sspcloud.fr/formation)
:::

## Pourquoi utiliser le SSP Cloud ?

- P√©nible d'installer `Python` et une ribambelle de _packages_ de _data science_
- Mise √† disposition d'un environnement standardis√©:
    + TP parfaitement reproductibles
- Un TP peut √™tre lanc√© en un clic-bouton:
    + <a href="https://datalab.sspcloud.fr/launcher/ide/jupyter-python?autoLaunch=true&amp;onyxia.friendlyName=%C2%ABpython-datascience%C2%BB&amp;init.personalInit=%C2%ABhttps%3A%2F%2Fraw.githubusercontent.com%2Flinogaliana%2Fpython-datascientist%2Fmaster%2Fsspcloud%2Finit-jupyter.sh%C2%BB&amp;init.personalInitArgs=%C2%ABmodelisation%206_pipeline%C2%BB&amp;security.allowlist.enabled=false" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/SSP%20Cloud-Tester_avec_Jupyter-orange?logo=Jupyter&amp;logoColor=orange" alt="Onyxia"></a>


## Cr√©er un compte

- Utiliser votre adresse `@dauphine.psl.eu` pour cr√©er un compte sur [datalab.sspcloud.fr/](https://datalab.sspcloud.fr/)
- Votre nom d‚Äôutilisateur ne doit contenir ni caract√®res accentu√©s, ni caract√®re sp√©cial, ni signe de ponctuation:

> Vous pouvez adopter le format prenomnom en faisant attention aux r√®gles pr√©c√©dentes. Par exemple, si vous vous appelez J√©r√¥me-G√©rard L‚ÄôH√¢lt√®re, votre nom d‚Äôutilisateur pourra √™tre __jeromegerardlhaltere__.


## Application 1

- Objectifs:
    - Mod√®le de prix sur donn√©es immobili√®res ;
    - _Feature engineering_, validation crois√©e, etc. ;
    - D√©couvrir les _pipelines_ `Scikit` ;

- Direction üëâÔ∏è chapitre _"Pipeline"_ de [https://pythonds.linogaliana.fr](https://pythonds.linogaliana.fr/content/modelisation/6_pipeline.html)



# Mise en production de notre mod√®le

## Vers la mise en production

- On a construit un projet de data science [**reproductible**]{.orange} et conforme aux [**standards**]{.orange} des bonnes pratiques.

. . .

- Pour [**valoriser**]{.orange} le projet, il faut le [**d√©ployer**]{.orange} dans un environnement en lien avec les [**utilisateurs**]{.blue2}:
    - Quel est le [**format**]{.blue2} adapt√© pour le valoriser ?
    - Quelle [**infrastructure de production**]{.blue2} ?
    - Comment [**automatiser**]{.blue2} le processus de d√©ploiement ?

## Format de valorisation

- [**Crit√®res**]{.orange} √† prendre en compte :
    - Quels sont les [**utilisateurs**]{.blue2} potentiels ?
    - Seulement de la [**mise √† disposition**]{.blue2}, ou besoin d'[**interactivit√©**]{.blue2} ?
    - Sp√©cificit√©s ML : entra√Ænement en [**batch**]{.blue2} ou [**online**]{.blue2} ?
    - Besoin de [**scalabilit√©**]{.blue2} ?

- [**Formats usuels**]{.orange} : API, application web, dashboard, site internet, rapport automatis√©...

## _Workflow_ classique

<br>
Progresser pas √† pas pour faciliter l'utilisation du mod√®le:

::: {.incremental}
1. Transformer les _notebooks_ en **[_script_]{.orange}** ;
2. Cr√©er une [__API en local__]{.orange} avec {{< fa brands python >}} pour faciliter le `predict` ;
3. [__D√©ployer l'API__]{.orange} pour la rendre disponible √† tous ;
4. Greffer des [__applications clientes__]{.orange} pour faciliter l'usage.
:::

::: {.callout-note}
Chaque √©tape est une progression dans l'√©chelle de la technicit√© et de la reproductibilit√©.
:::


## Exposer un mod√®le via une API REST

- [**API** : **interface**]{.orange} entre l'utilisateur (client) et le mod√®le entra√Æn√©

- [**API REST**]{.orange} : permet de requ√™ter le mod√®le avec une syntaxe simple (HTTP) et de mani√®re *scalable*

. . .

![](https://ensae-reproductibilite.github.io/slides/img/api-docker.png){fig-align="center"}

## D√©velopper une API en local {.scrollable}

<h4>Etape 1: modulariser la consommation du mod√®le</h4>

* _Scripts_ pour les diff√©rentes √©tapes du _pipeline_ ML:
    + R√©cup√©ration des donn√©es ;
    + D√©finition _pipeline_ `Scikit`: _preprocessing_, _training_ ;
    + Consommation du mod√®le pour `predict`.

. . .

* D√©finir une fonction qui prend en argument les variables du mod√®le

<details>
<summary>
Exemple
</summary>

::: {.python}
```python
def predict(
    month: int = 3,
    nombre_lots: int = 1,
    code_type_local: int = 2,
    nombre_pieces_principales: int = 3,
    surface: float = 75
) -> float:
    """
    """

    df = pd.DataFrame(
        {
            "month": [month],
            "Nombre_de_lots": [nombre_lots],
            "Code_type_local": [code_type_local],
            "Nombre_pieces_principales": [nombre_pieces_principales],
            "surface": [surface]
        }
    )

    prediction = model.predict(df)

    return prediction
```
:::

</details>


## D√©velopper une API en local {.scrollable}

<h4>Etape 2: cr√©er une API en local</h4>

- `FastAPI`: _framework_ simple pour cr√©er une API avec {{< fa brands python >}}
    + Tr√®s simple de transformer fonctions en API ; 
    + Documentation automatis√©e pour le _swagger_

<details>
<summary>
Exemple
</summary>

::: {.python}
```python
@app.get("/predict", tags=["Predict"])
async def predict(
    month: int = 3,
    nombre_lots: int = 1,
    code_type_local: int = 2,
    nombre_pieces_principales: int = 3,
    surface: float = 75
) -> float:
    """
    """

    df = pd.DataFrame(
        {
            "month": [month],
            "Nombre_de_lots": [nombre_lots],
            "Code_type_local": [code_type_local],
            "Nombre_pieces_principales": [nombre_pieces_principales],
            "surface": [surface]
        }
    )

    prediction = model.predict(df)

    return prediction
```
:::

</details>

## D√©ployer une API

- Rendre disponible √† d'autres utilisateurs l'API ;
- 

## Aller plus loin

:::: {.columns}

::: {.column width="50%"}
```{ojs}
html`<div>Nombre de pi√®ces</div><div>${viewof pieces_principales}</div>`
```
:::

::: {.column width="50%"}
```{ojs}
html`<div>Surface de l'appartement</div><div>${viewof surface}</div>`
```
:::

::::

```{ojs}
viewof pieces_principales = Inputs.range([1, 12], {step: 1, value: 6})
```

```{ojs}
viewof surface = Inputs.range([1, 300], {step: 1, value: 50})
```


```{ojs}
md`${return_message}`
```



```{ojs}
url_api_dvf = `https://corsproxy.io/?https://dvf-simple-api.lab.sspcloud.fr/predict?month=4&nombre_lots=1&code_type_local=2&nombre_pieces_principales=${pieces_principales}&surface=${surface}`
```

```{ojs}
value = d3.json(url_api_dvf).then(data => {
    // Access the 'value' property from the object
    let originalNumber = data;

    // Convert it to a floating-point number
    let numericValue = parseFloat(originalNumber);

    // Round the number
    let roundedNumber = Math.round(numericValue).toLocaleString();

    return roundedNumber;
}).catch(error => console.error('Error:', error));
```

```{ojs}
return_message = `Valeur estim√©e de l'appartement: __${value} ‚Ç¨__`
```


